<div class="flex w-full flex-col p-6">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Nouveau Transfert</h1>
        <p class="mt-2 text-gray-600">Créer un transfert en attente de validation</p>
    </div>

    @if (activeBeneficiaries().length === 0) {
        <!-- No Beneficiaries State -->
        <mat-card class="p-8 text-center">
            <mat-icon class="mb-4 text-6xl text-gray-400">people_outline</mat-icon>
            <h2 class="mb-4 text-xl font-semibold">Aucun bénéficiaire disponible</h2>
            <p class="mb-6 text-gray-600">
                Vous devez d'abord ajouter des bénéficiaires pour effectuer un transfert.
            </p>
            <button mat-raised-button color="primary" routerLink="/client/beneficiaries">
                Ajouter un bénéficiaire
            </button>
        </mat-card>
    } @else if (isTransferCreated()) {
        <!-- Success State -->
        <mat-card class="p-8 text-center">
            <div class="mb-6">
                <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center">
                    <mat-icon class="text-3xl text-green-600">check_circle</mat-icon>
                </div>
            </div>
            <h2 class="mb-4 text-2xl font-semibold text-green-800">Transfert créé avec succès!</h2>
            <p class="mb-6 text-gray-600">
                Votre transfert a été créé et est en attente de validation par l'administrateur.
            </p>
            
            @if (transferSummary()) {
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6 text-left">
                    <h3 class="text-lg font-semibold text-green-800 mb-4">Détails du transfert</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Référence:</span>
                            <code class="bg-white px-2 py-1 rounded text-sm">{{ transferSummary()?.reference }}</code>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Bénéficiaire:</span>
                            <span class="font-medium">{{ transferSummary()?.beneficiaryName }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Montant:</span>
                            <span class="font-bold text-green-800">{{ transferSummary()?.amount | number:'1.2-2' }} TND</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Frais:</span>
                            <span>{{ transferSummary()?.fees | number:'1.2-2' }} TND</span>
                        </div>
                        <mat-divider></mat-divider>
                        <div class="flex justify-between text-lg">
                            <span class="font-semibold">Total:</span>
                            <span class="font-bold text-green-800">{{ transferSummary()?.totalAmount | number:'1.2-2' }} TND</span>
                        </div>
                    </div>
                </div>
            }

            <div class="space-x-4">
                <button mat-raised-button color="primary" (click)="resetForm()">
                    Nouveau transfert
                </button>
                <button mat-button [routerLink]="['/client/history']">
                    Voir l'historique
                </button>
            </div>
        </mat-card>
    } @else {
        <!-- Transfer Form -->
        <mat-card class="p-6">
            <form [formGroup]="transferForm" (ngSubmit)="initiateTransfer()">
                <div class="space-y-6">
                    <!-- Beneficiary Selection -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Bénéficiaire</mat-label>
                        <mat-select formControlName="beneficiaryId">
                            @for (beneficiary of activeBeneficiaries(); track beneficiary.id) {
                                <mat-option [value]="beneficiary.id">
                                    <div class="flex flex-col">
                                        <span class="font-medium">{{ beneficiary.name }}</span>
                                        <span class="text-sm text-gray-600">{{ beneficiary.rib }}</span>
                                    </div>
                                </mat-option>
                            }
                        </mat-select>
                        @if (getFormFieldError('beneficiaryId')) {
                            <mat-error>{{ getFormFieldError('beneficiaryId') }}</mat-error>
                        }
                    </mat-form-field>

                    <!-- Amount -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Montant</mat-label>
                        <input matInput type="number" formControlName="amount" 
                               placeholder="0.00" min="0.01" max="1000000" step="0.01">
                        <span matTextSuffix>TND</span>
                        @if (getFormFieldError('amount')) {
                            <mat-error>{{ getFormFieldError('amount') }}</mat-error>
                        }
                        <mat-hint>Limite: 1,000,000 TND</mat-hint>
                    </mat-form-field>

                    <!-- Reason -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Motif du transfert</mat-label>
                        <textarea matInput formControlName="reason" 
                                placeholder="Saisir le motif du transfert..."
                                rows="3" maxlength="500"></textarea>
                        @if (getFormFieldError('reason')) {
                            <mat-error>{{ getFormFieldError('reason') }}</mat-error>
                        }
                        <mat-hint>{{ transferForm.get('reason')?.value?.length || 0 }}/500 caractères</mat-hint>
                    </mat-form-field>

                    <!-- Selected Beneficiary Info -->
                    @if (selectedBeneficiary()) {
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h3 class="font-semibold text-blue-900 mb-2">Bénéficiaire sélectionné</h3>
                            <div class="text-blue-800">
                                <p><strong>Nom:</strong> {{ selectedBeneficiary()?.name }}</p>
                                <p><strong>RIB:</strong> {{ selectedBeneficiary()?.rib }}</p>
                            </div>
                        </div>
                    }

                    <!-- Important Notice -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <mat-icon class="text-yellow-600 mr-2 mt-1">info</mat-icon>
                            <div>
                                <h4 class="font-semibold text-yellow-800 mb-1">Information importante</h4>
                                <p class="text-yellow-700 text-sm">
                                    Ce transfert sera créé en statut "En attente" et devra être validé par un administrateur avant d'être exécuté.
                                    Vous recevrez une notification une fois le transfert validé et exécuté.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end mt-8 pt-4 border-t">
                    <div class="space-x-4">
                        <button mat-button type="button" [routerLink]="['/client']">
                            Annuler
                        </button>
                        <button mat-raised-button color="primary" type="submit" 
                                [disabled]="!transferForm.valid || isLoading()">
                            @if (isLoading()) {
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                            }
                            Créer le transfert
                        </button>
                    </div>
                </div>
            </form>
        </mat-card>
    }
</div>
